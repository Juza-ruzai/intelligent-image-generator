<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能生图工具 (Web版)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f0f2f5;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
            margin-left: auto;
            margin-right: auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .drop-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .drop-zone.drag-over {
            border-color: #4f46e5;
            background-color: #e0e7ff;
        }
        .tag-checkbox {
            display: inline-block;
            position: relative;
        }
        .tag-checkbox input[type="checkbox"] {
            display: none;
        }
        .tag-checkbox span {
            display: inline-block;
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem;
            color: #4b5563;
        }
        .tag-checkbox input[type="checkbox"]:checked + span {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .prompt-section-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        /* 新增：趣味玩法按钮样式 */
        .fun-play-button {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
        }
        .fun-play-button:hover {
            background-color: #e0e7ff;
            border-color: #a5b4fc;
            color: #4f46e5;
        }
        /* 新增：自定义消息通知样式 */
        #toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, top 0.3s;
        }
        #toast-notification.show {
            top: 40px;
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="antialiased text-gray-800 p-4 md:p-8">
    
    <!-- 新增：消息通知容器 -->
    <div id="toast-notification"></div>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold tracking-tight">智能生图工具</h1>
            <p class="mt-3 text-lg text-gray-600">为建筑与施工领域打造的专业渲染工具</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card p-6 md:p-8 space-y-6">
                <div>
                    <label for="model-select" class="block text-sm font-medium text-gray-700 mb-2">1. 选择AI模型</label>
                    <select id="model-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="gemini_i2i">Google Gemini (图生图)</option>
                        <option value="ark_i2i" selected>Volcengine Ark (图生图)</option>
                        <option value="ark_t2i">Volcengine Ark (文生图)</option>
                    </select>
                </div>

                <div id="image-upload-section">
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. 输入源图片 (图生图模式)</label>
                    <div id="drop-zone" class="drop-zone w-full p-4 text-center rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 min-h-[200px] flex flex-col justify-center items-center">
                        <div id="upload-instructions">
                            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            <p class="mt-2 text-sm text-gray-600"><span class="font-semibold text-indigo-600">点击上传</span>, 或拖拽文件到此</p>
                            <p class="text-xs text-gray-500">支持粘贴剪贴板中的图片 (Ctrl+V)</p>
                        </div>
                        <img id="image-preview" class="hidden max-h-48 rounded-lg" alt="图片预览"/>
                    </div>
                    <input type="file" id="image-input" class="hidden" accept="image/png, image/jpeg">
                </div>

                <div id="prompt-builder-container" class="space-y-6">
                     <label class="block text-sm font-medium text-gray-700 mb-2">3. 构建专业渲染指令</label>

                     <div class="space-y-4 p-4 border rounded-lg">
                         <h3 class="prompt-section-title">I. 渲染风格控制</h3>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                 <label for="style-select" class="block text-xs font-medium text-gray-600 mb-1">表现风格</label>
                                 <select id="style-select" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                                     <option value="" selected>— 未指定 —</option>
                                     <optgroup label="写实类表现">
                                         <option value="hyperrealistic architectural render">超写实建筑渲染</option>
                                         <option value="photorealistic construction site">工地实景模拟</option>
                                         <option value="material showcase render">材质样板渲染</option>
                                     </optgroup>
                                     <optgroup label="方案类表现">
                                         <option value="conceptual sketch perspective">概念草图透视</option>
                                         <option value="watercolor architectural drawing">水彩建筑图</option>
                                         <option value="BIM sectional rendering">BIM剖切渲染</option>
                                         <option value="minimalist architectural model">极简建筑模型</option>
                                     </optgroup>
                                 </select>
                             </div>
                             <div>
                                 <label class="block text-xs font-medium text-gray-600 mb-1">画质参数</label>
                                 <div class="flex flex-wrap gap-2 pt-1">
                                     <label class="tag-checkbox"><input type="checkbox" value="architectural masterpiece"><span>大师级作品</span></label>
                                     <label class="tag-checkbox"><input type="checkbox" value="Ultra-high resolution"><span>极致超高清</span></label>
                                     <label class="tag-checkbox"><input type="checkbox" value="ultra-detailed texture"><span>极致纹理细节</span></label>
                                     <label class="tag-checkbox"><input type="checkbox" value="realistic lighting simulation"><span>真实光影模拟</span></label>
                                 </div>
                             </div>
                         </div>
                       </div>

                     <div class="space-y-4 p-4 border rounded-lg">
                         <h3 class="prompt-section-title">II. 建筑主体参数</h3>
                         <div>
                             <label class="block text-xs font-medium text-gray-600 mb-2">主要建筑材质</label>
                             <div class="flex flex-wrap gap-2">
                                 <label class="tag-checkbox"><input type="checkbox" value="exposed concrete structure"><span>清水混凝土结构</span></label>
                                 <label class="tag-checkbox"><input type="checkbox" value="unitized glass curtain wall"><span>单元式玻璃幕墙</span></label>
                                 <label class="tag-checkbox"><input type="checkbox" value="perforated aluminum facade"><span>穿孔铝单板幕墙</span></label>
                                 <label class="tag-checkbox"><input type="checkbox" value="wooden curtain wall system"><span>木质幕墙系统</span></label>
                                 <label class="tag-checkbox"><input type="checkbox" value="terracotta panel cladding"><span>陶土板饰面</span></label>
                                 <label class="tag-checkbox"><input type="checkbox" value="stone veneer facade"><span>石材干挂幕墙</span></label>
                             </div>
                         </div>
                          <div>
                             <label class="block text-xs font-medium text-gray-600 mb-2">施工阶段状态</label>
                             <div class="flex flex-wrap gap-2">
                                 <label class="tag-checkbox"><input type="checkbox" value="foundation construction phase"><span>基础施工阶段</span></label>
                                 <label class="tag-checkbox"><input type="checkbox" value="steel structure erection"><span>钢结构吊装</span></label>
                                 <label class="tag-checkbox"><input type="checkbox" value="concrete formwork stage"><span>混凝土模板阶段</span></label>
                                 <label class="tag-checkbox"><input type="checkbox" value="scaffolding system setup"><span>脚手架搭设</span></label>
                                 <label class="tag-checkbox"><input type="checkbox" value="tower crane operation"><span>塔吊作业中</span></label>
                                 <label class="tag-checkbox"><input type="checkbox" value="facade installation phase"><span>幕墙安装阶段</span></label>
                             </div>
                         </div>
                       </div>
                       
                     <div class="space-y-4 p-4 border rounded-lg">
                         <h3 class="prompt-section-title">III. 环境与场景设置</h3>
                         <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                              <div>
                                 <label for="location-select" class="block text-xs font-medium text-gray-600 mb-1">场地环境</label>
                                 <select id="location-select" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                                     <option value="" selected>— 未指定 —</option>
                                     <option value="urban central business district">城市中央商务区</option>
                                     <option value="suburban residential area">郊区住宅区</option>
                                     <option value="mountainous architectural site">山地建筑场地</option>
                                     <option value="coastal architectural environment">海滨建筑环境</option>
                                     <option value="industrial park construction site">工业园区工地</option>
                                     <option value="heritage conservation area">历史保护街区</option>
                                 </select>
                             </div>
                             <div>
                                 <label for="lighting-select" class="block text-xs font-medium text-gray-600 mb-1">光照条件</label>
                                 <select id="lighting-select" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                                     <option value="" selected>— 未指定 —</option>
                                     <option value="summer midday sunlight">夏季正午阳光</option>
                                     <option value="overcast diffuse lighting">阴天漫射光</option>
                                     <option value="golden hour architectural lighting">建筑黄金时刻</option>
                                     <option value="blue hour twilight effect">蓝色时刻暮光</option>
                                     <option value="nighttime architectural lighting">建筑夜间照明</option>
                                     <option value="artificial construction lighting">工地人工照明</option>
                                 </select>
                             </div>
                              <div>
                                 <label for="viewpoint-select" class="block text-xs font-medium text-gray-600 mb-1">视角设置</label>
                                 <select id="viewpoint-select" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                                     <option value="" selected>— 未指定 —</option>
                                     <option value="human-eye perspective view">人眼透视视角</option>
                                     <option value="drone aerial perspective">无人机航拍视角</option>
                                     <option value="architectural bird's-eye view">建筑鸟瞰图</option>
                                     <option value="worm's-eye elevation view">仰角立面视角</option>
                                     <option value="sectional perspective view">剖切透视视角</option>
                                     <option value="construction site plan view">工地平面视角</option>
                                 </select>
                             </div>
                         </div>
                       </div>

                    <!-- ================== 新增：趣味玩法模块 ================== -->
                    <div class="space-y-4 p-4 border rounded-lg">
                        <h3 class="prompt-section-title">IV. ✨ 趣味玩法 (一键应用)</h3>
                        <div id="fun-play-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <button class="fun-play-button" data-preset="building-to-3d-model">建筑 → 3D模型</button>
                            <button class="fun-play-button" data-preset="building-to-game-model">建筑 → 3D游戏模型</button>
                            <button class="fun-play-button" data-preset="building-to-isometric">建筑 → 等距瓷砖模型</button>
                            <button class="fun-play-button" data-preset="building-to-lego">建筑 → 乐高风模型</button>
                            <button class="fun-play-button" data-preset="sketch-to-photo">线稿 → 真实照片</button>
                            <button class="fun-play-button" data-preset="photo-to-BANDAI">照片 → 人物手办</button>
                        </div>
                    </div>
                    <!-- ======================================================= -->

                     <div>
                         <label for="combined-prompt-input" class="block text-sm font-medium text-gray-700 mb-2">4. 专业渲染指令 (可手动编辑)</label>
                         <textarea id="combined-prompt-input" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm" placeholder="支持输入建筑术语如'参数化表皮'、'预制装配式结构'等..."></textarea>
                     </div>
                </div>
                <button id="generate-btn" class="w-full flex justify-center items-center gap-3 text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-full py-3 px-6 transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <svg id="generate-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    <svg id="regenerate-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l16 16" /></svg>
                    <span id="generate-btn-text">开始智能生图</span>
                </button>
                
                <div id="action-buttons" class="w-full flex-shrink-0 flex gap-4 pt-2">
                     <button id="use-as-input-btn" class="flex-1 flex items-center justify-center gap-2 text-sm font-medium rounded-lg py-2 px-4 transition-all text-indigo-600 bg-indigo-50 hover:bg-indigo-100 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed" disabled>
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16l-4-4m0 0l4-4m-4 4h18" /></svg>
                         迭代
                     </button>
                     <button id="save-btn" class="flex-1 flex items-center justify-center gap-2 text-sm font-medium rounded-lg py-2 px-4 transition-all text-green-600 bg-green-50 hover:bg-green-100 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed" disabled>
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                         保存
                     </button>
                </div>
            </div>

            <div class="card p-6 md:p-8 flex flex-col items-center justify-center min-h-[500px]">
                <div id="result-container" class="w-full flex flex-col items-center justify-center flex-grow min-h-0">
                    <div id="result-placeholder" class="text-center text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="mt-2 font-medium">AI生成的结果将显示在这里</p>
                    </div>
                    <div id="loading-indicator" class="hidden text-center text-gray-600">
                        <div class="spinner"></div>
                        <p class="mt-4 font-medium">正在生成中，请稍候...</p>
                        <p class="text-sm text-gray-500">这可能需要几十秒的时间</p>
                    </div>
                    <img id="result-image" class="hidden w-full h-auto max-h-full object-contain rounded-lg" alt="AI生成结果"/>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Element Selection ---
        const modelSelect = document.getElementById('model-select');
        const imageUploadSection = document.getElementById('image-upload-section');
        const dropZone = document.getElementById('drop-zone');
        const uploadInstructions = document.getElementById('upload-instructions');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const combinedPromptInput = document.getElementById('combined-prompt-input'); 
        const generateBtn = document.getElementById('generate-btn');
        const generateBtnText = document.getElementById('generate-btn-text');
        const generateIcon = document.getElementById('generate-icon');
        const regenerateIcon = document.getElementById('regenerate-icon');
        const useAsInputBtn = document.getElementById('use-as-input-btn');
        const saveBtn = document.getElementById('save-btn');
        const resultImage = document.getElementById('result-image');
        const resultPlaceholder = document.getElementById('result-placeholder');
        const loadingIndicator = document.getElementById('loading-indicator');
        const toast = document.getElementById('toast-notification');
        const promptBuilderContainer = document.getElementById('prompt-builder-container');
        const funPlayContainer = document.getElementById('fun-play-container');
        let selectedFile = null;

        // --- 新增：趣味玩法提示词库 ---
        const funPlayPresets = {
            'building-to-3d-model': 'High-fidelity 3D model of the building, architectural visualization, clean background, studio lighting, unreal engine 5, octane render, 8k',
            'building-to-game-model':"Based on this building photo, generate a high-fidelity 3D building model in the style of Cities: Skylines. Key Requirements:Strive for a realistic appearance, preserving the building's key structural and textural details, but stylized to reflect the game's style.Use a top-down perspective to convey the building's three-dimensionality.Materials should be clearly defined, such as reflective glass and metal surfaces. It should resemble a high-quality 3D render suitable for a game engine.The background should be set to white",
            'building-to-isometric': '将此建筑的照片转换为圆润可爱的等距瓷砖3D渲染风格，比例为1：1，以保留拍摄建筑的突出特征',
            'building-to-lego': 'Rebuilt with LEGO bricks, lego model, macro photography, studio lighting, plastic texture, vibrant colors, playful, high detail',
            'sketch-to-photo': 'Transform the sketch into a photorealistic image, professional photography, Canon EOS 5D Mark IV, 85mm f/1.2 lens, ultra-detailed, sharp focus',
            'photo-to-BANDAI': '按照图片中人物，在真实环境中，以写实风格，制作一个1/7比例的商品化手办模型。手办模型放置在电脑桌上，有一个圆形透明亚克力底座，底座上没有文字。电脑屏幕上显示这个手办模型的Zbrush建模过程。电脑屏幕旁边放置一个印有原图的BANDAl风格玩具包装盒。'
        };

        // --- Smart Prompt Management Logic ---
        const allUIKeywords = new Set();
        const activeUIKeywords = new Set();

        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function updatePromptTextarea() {
            const currentTextParts = combinedPromptInput.value.split(/,\s*/).filter(p => p.trim() !== '');
            const manualParts = currentTextParts.filter(part => !allUIKeywords.has(part));
            const structuredParts = Array.from(activeUIKeywords);
            const finalParts = [...structuredParts, ...manualParts];
            combinedPromptInput.value = finalParts.join(', ');
        }
        
        function handleCheckboxChange(event) {
            const keyword = event.target.value;
            if (event.target.checked) {
                activeUIKeywords.add(keyword);
            } else {
                activeUIKeywords.delete(keyword);
            }
            updatePromptTextarea();
        }

        function handleSelectChange(event) {
            const newKeyword = event.target.value;
            const oldKeyword = event.target.dataset.previousValue;

            if (oldKeyword) {
                activeUIKeywords.delete(oldKeyword);
            }
            if (newKeyword) {
                activeUIKeywords.add(newKeyword);
            }
            
            event.target.dataset.previousValue = newKeyword;
            updatePromptTextarea();
        }

        // --- 新增：重置所有提示词控件的函数 ---
        function resetPromptBuilder() {
            // 1. 取消所有复选框的选中状态
            promptBuilderContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            // 2. 重置所有下拉框到第一个选项
            promptBuilderContainer.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
                delete select.dataset.previousValue;
            });
            
            // 3. 清空UI关键词集合
            activeUIKeywords.clear();
            
            // 4. 清空手动输入区域（只保留非UI生成的关键词，通常为空）
            const currentTextParts = combinedPromptInput.value.split(/,\s*/).filter(p => p.trim() !== '');
            const manualParts = currentTextParts.filter(part => !allUIKeywords.has(part));
            combinedPromptInput.value = manualParts.join(', ');
        }

        function initializePromptState() {
            promptBuilderContainer.querySelectorAll('[value]').forEach(el => {
                if (el.value) allUIKeywords.add(el.value);
            });

            promptBuilderContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
                if (checkbox.checked) activeUIKeywords.add(checkbox.value);
            });
            promptBuilderContainer.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', handleSelectChange);
                if (select.value) {
                    activeUIKeywords.add(select.value);
                    select.dataset.previousValue = select.value;
                }
            });

            updatePromptTextarea();
        }

        // --- Core Functions ---
        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    uploadInstructions.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                showToast('请上传有效的图片文件 (png, jpg, jpeg)。');
            }
        }

        // --- Event Listeners ---
        modelSelect.addEventListener('change', () => {
            const selectedModel = modelSelect.value;
            imageUploadSection.style.display = selectedModel.includes('_i2i') ? 'block' : 'none';
            if (!selectedModel.includes('_i2i')) {
                imageInput.value = '';
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
                uploadInstructions.classList.remove('hidden');
                selectedFile = null;
            }
        });

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });
        dropZone.addEventListener('click', () => imageInput.click());
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    if (imageUploadSection.style.display !== 'none') handleFile(file);
                    else showToast("已成功粘贴图片。请先切换到'图生图'模型以使用此图片。");
                    return;
                }
            }
        });
        
        imageInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        // --- 新增：趣味玩法按钮点击事件 ---
        funPlayContainer.addEventListener('click', (event) => {
            const button = event.target.closest('.fun-play-button');
            if (!button) return;

            const presetKey = button.dataset.preset;
            const presetPrompt = funPlayPresets[presetKey];

            if (presetPrompt) {
                // 1. 重置所有专业指令控件
                resetPromptBuilder();
                // 2. 将预设提示词直接设置为文本框的值
                combinedPromptInput.value = presetPrompt;
                showToast(`已应用玩法: ${button.textContent}`, 2000);
            }
        });
        
        generateBtn.addEventListener('click', async () => {
            const model = modelSelect.value;
            const prompt = combinedPromptInput.value.trim(); 

            if (!prompt) {
                showToast('请至少选择一个渲染选项或输入具体指令。');
                return;
            }
            if (model.includes('_i2i') && !selectedFile) {
                showToast('图生图模式需要您上传一张源图片。');
                return;
            }
            
            setLoadingState(true);
            
            const formData = new FormData();
            formData.append('model', model);
            formData.append('prompt', prompt);
            if (model.includes('_i2i') && selectedFile) {
                formData.append('image', selectedFile);
            }
            
            try {
                // 注意：后端服务在此地址运行
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `HTTP错误，状态码: ${response.status}`);
                displayResult(result.imageData);
            } catch (error) {
                console.error('生成图片时发生错误:', error);
                const errorMessage = error.message.includes('Failed to fetch') 
                    ? '无法连接到后端服务。请确认您的Python后端正在运行。' 
                    : error.message;
                showToast(`生成失败: ${errorMessage}`);
                setLoadingState(false, true);
            }
        });

        saveBtn.addEventListener('click', () => {
            if (!resultImage.src || !resultImage.src.startsWith('data:image')) return;
            const link = document.createElement('a');
            link.href = resultImage.src;
            link.download = `generated_image_${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        useAsInputBtn.addEventListener('click', async () => {
            if (!resultImage.src || !resultImage.src.startsWith('data:image')) return;
            const blob = await (await fetch(resultImage.src)).blob();
            const file = new File([blob], "generated_image.png", { type: blob.type });
            if (!modelSelect.value.includes('_i2i')) {
                const i2i_option = Array.from(modelSelect.options).find(opt => opt.value.includes('_i2i'));
                if(i2i_option) modelSelect.value = i2i_option.value;
            }
            modelSelect.dispatchEvent(new Event('change'));
            handleFile(file);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // --- Helper Functions ---
        function setLoadingState(isLoading, hasError = false) {
            generateBtn.disabled = isLoading;
            
            if (isLoading) {
                useAsInputBtn.disabled = true;
                saveBtn.disabled = true;
                resultPlaceholder.classList.add('hidden');
                resultImage.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
                if (hasError) {
                    resultPlaceholder.classList.remove('hidden');
                }
            }
        }

        function displayResult(base64Data) {
            resultImage.src = `data:image/png;base64,${base64Data}`;
            resultImage.classList.remove('hidden');
            useAsInputBtn.disabled = false;
            saveBtn.disabled = false;
            generateBtnText.textContent = '重新生成';
            generateIcon.classList.add('hidden');
            regenerateIcon.classList.remove('hidden');
            setLoadingState(false);
        }
        
        // Initial call to set the prompt state on page load
        document.addEventListener('DOMContentLoaded', initializePromptState);
    </script>
</body>
</html>
